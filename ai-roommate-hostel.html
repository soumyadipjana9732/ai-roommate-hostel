<!doctype html>
<!--
AI Roommate Matching & Hostel Allocation
Single-file HTML / CSS / JavaScript
Designed for competition: colorful, accessible, modular, advanced front-end logic.
Notes:
- This is a self-contained front-end prototype; backend endpoints are stubbed via localStorage and simulated async functions.
- Matching algorithm: weighted-similarity + constraint solver + hill-climb improvements + diversity boosting.
- Allocation algorithm: best-fit room packing with preference scores and constraints.
- Includes interactive UI, animations, SVG icons, charts (canvas), drag-and-drop, export/import JSON, printable reports.
- Commented thoroughly for learning and competition judging.

Author: Generated for user
Version: 1.0
-->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Roommate Matching & Hostel Allocation — Prototype</title>
  <meta name="description" content="Advanced AI-driven roommate matching and hostel allocation front-end prototype." />
  <style>
    /* =========  Reset & Base ========= */
    :root{
      --bg:#0f1724; /* deep night */
      --card:#0b1220;
      --muted:#9aa7c0;
      --accent1:#7c3aed; /* violet */
      --accent2:#06b6d4; /* teal */
      --accent3:#f97316; /* orange */
      --glass: rgba(255,255,255,0.04);
      --success:#10b981;
      --danger:#ef4444;
      --maxw:1200px;
      --radius:12px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color-scheme: dark;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      padding:28px;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(124,58,237,0.12), transparent),
                  radial-gradient(900px 500px at 90% 90%, rgba(6,182,212,0.06), transparent),
                  var(--bg);
      color:#dbeafe;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.35;
    }
    .container{
      max-width:var(--maxw);
      margin:0 auto;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:20px;
      align-items:start;
    }

    /* ========= Sidebar ========= */
    .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border:1px solid rgba(255,255,255,0.04);
      border-radius:var(--radius);
      padding:18px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.6);
      position:sticky; top:28px;
    }
    .brand{
      display:flex; gap:12px; align-items:center; margin-bottom:12px;
    }
    .logo{
      height:56px; width:56px; border-radius:12px; display:grid; place-items:center;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      box-shadow: 0 6px 18px rgba(7,12,32,0.6);
      font-weight:700; font-size:18px;
    }
    h1{font-size:18px;margin:0}
    p.lead{color:var(--muted);margin:6px 0 16px;font-size:13px}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; cursor:pointer; user-select:none; font-weight:600;}
    .btn-primary{background:linear-gradient(90deg,var(--accent2),var(--accent1)); color:white; border:none}
    .btn-ghost{background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted)}

    /* sidebar menu */
    .menu{display:flex; flex-direction:column; gap:8px}
    .menu button{background:transparent; border:none; text-align:left; padding:10px; border-radius:8px; color:var(--muted); font-weight:600}
    .menu button.active{background:linear-gradient(90deg, rgba(124,58,237,0.12), rgba(6,182,212,0.06)); color:var(--accent2)}

    /* ========= Main ========= */
    .main{
      min-height:80vh;
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius:14px; padding:16px; margin-bottom:16px; border:1px solid rgba(255,255,255,0.04);
      box-shadow: 0 6px 20px rgba(2,6,23,0.5);
    }
    .flex{display:flex; gap:12px; align-items:center}
    .grid{display:grid; gap:12px}

    /* form elements */
    label{font-size:13px; color:var(--muted); display:block; margin-bottom:6px}
    input[type=text], input[type=number], select, textarea{
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit;
      outline:none; transition:box-shadow .15s, border-color .15s;
    }
    input:focus, select:focus, textarea:focus{box-shadow:0 6px 18px rgba(7,12,32,0.6); border-color:rgba(124,58,237,0.5)}

    /* User list */
    .user-list{display:flex; flex-direction:column; gap:10px; max-height:62vh; overflow:auto; padding-right:6px}
    .user-card{display:flex; gap:10px; align-items:center; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .avatar{height:56px; width:56px; border-radius:10px; display:grid; place-items:center; font-weight:700}
    .meta{flex:1}
    .tags{display:flex; gap:6px; flex-wrap:wrap}
    .tag{background:var(--glass); padding:6px 8px; border-radius:999px; font-size:12px; color:var(--muted)}

    /* match matrix */
    .matrix{overflow:auto}
    table{border-collapse:collapse; width:100%}
    th,td{padding:8px 10px; text-align:left; font-size:13px}
    th{color:var(--muted); font-weight:700; border-bottom:1px solid rgba(255,255,255,0.03)}
    td.score{font-weight:700}

    /* controls */
    .controls{display:flex; gap:8px; flex-wrap:wrap}

    /* Allocation view */
    .rooms{display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:12px}
    .room{padding:12px; border-radius:10px; min-height:120px; display:flex; flex-direction:column; gap:8px}
    .room .room-name{font-weight:800}
    .room.small{min-height:90px}

    /* footer */
    footer{margin-top:18px; color:var(--muted); font-size:13px}

    /* nice micro-animations */
    .pulse{animation:pulse 3s infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}

    /* responsive */
    @media (max-width:980px){
      .container{grid-template-columns: 1fr}
      .sidebar{position:relative}
    }

    /* fancy progress */
    .progress{height:10px; background:rgba(255,255,255,0.03); border-radius:999px; overflow:hidden}
    .progress > i{display:block; height:100%; border-radius:999px; background:linear-gradient(90deg,var(--accent1),var(--accent2))}

    /* badges */
    .badge{padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px}
    .badge.good{background:linear-gradient(90deg, rgba(16,185,129,0.12), rgba(16,185,129,0.06)); color:var(--success)}
    .badge.warn{background:linear-gradient(90deg, rgba(249,115,22,0.08), rgba(249,115,22,0.04)); color:var(--accent3)}

    /* drag placeholder */
    .dragging{opacity:0.6}

    /* small helpers */
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, monospace}
  </style>
</head>
<body>
  <div class="container" role="main">
    <aside class="sidebar" aria-label="controls and navigation">
      <div class="brand">
        <div class="logo">AI</div>
        <div>
          <h1>RoomMate AI</h1>
          <p class="lead">Smart roommate matching & hostel allocation — visual demo</p>
        </div>
      </div>

      <div class="card" style="padding:12px; margin-bottom:12px">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px">
          <div>
            <div class="muted">Dataset</div>
            <div style="font-weight:800">Students: <span id="count-students">0</span></div>
          </div>
          <div style="text-align:right">
            <div class="muted">Rooms</div>
            <div style="font-weight:800">Rooms: <span id="count-rooms">0</span></div>
          </div>
        </div>
        <div style="height:10px; margin-top:12px" class="progress" aria-hidden="true"><i id="progress-bar" style="width:10%"></i></div>
      </div>

      <div class="menu">
        <button id="nav-students" class="active">Students</button>
        <button id="nav-match">Matching</button>
        <button id="nav-allocate">Allocation</button>
        <button id="nav-reports">Reports</button>
      </div>

      <div style="margin-top:12px; display:flex; gap:8px">
        <button class="btn btn-primary" id="btn-add-random">Add 20 Random</button>
        <button class="btn btn-ghost" id="btn-import">Import</button>
      </div>

      <div style="margin-top:12px; display:flex; gap:8px">
        <button class="btn btn-ghost" id="btn-export">Export</button>
        <button class="btn btn-ghost" id="btn-reset">Reset</button>
      </div>

      <div style="margin-top:14px">
        <label class="muted">Algorithm Controls</label>
        <div style="display:grid; gap:8px; margin-top:8px">
          <label>Preference Weight (0-2)</label>
          <input id="pref-weight" type="range" min="0" max="2" step="0.1" value="1">
          <label>Compatibility Weight (0-2)</label>
          <input id="comp-weight" type="range" min="0" max="2" step="0.1" value="1">
        </div>
      </div>

      <footer>
        <small>Prototype • Front-end only • Export JSON for backend</small>
      </footer>
    </aside>

    <main class="main">
      <!-- STUDENTS VIEW -->
      <section id="view-students" class="card">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <div>
            <h2 style="margin:0">Students</h2>
            <p class="muted">Create, edit, and manage student profiles and preferences.</p>
          </div>
          <div class="controls">
            <button class="btn btn-primary" id="btn-new-student">+ New Student</button>
            <button class="btn btn-ghost" id="btn-simulate-preferences">Simulate Prefs</button>
          </div>
        </div>

        <div style="display:flex; gap:12px; margin-top:12px">
          <div style="flex:1">
            <div class="card">
              <form id="student-form">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                  <div>
                    <label>Name</label>
                    <input id="s-name" required type="text" placeholder="e.g. Riya Sharma">
                  </div>
                  <div>
                    <label>Age</label>
                    <input id="s-age" type="number" min="17" max="40" value="20">
                  </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px">
                  <div>
                    <label>Gender</label>
                    <select id="s-gender">
                      <option value="f">Female</option>
                      <option value="m">Male</option>
                      <option value="o">Other</option>
                    </select>
                  </div>
                  <div>
                    <label>Study Program</label>
                    <input id="s-program" type="text" placeholder="e.g. B.Tech CSE">
                  </div>
                </div>

                <div style="margin-top:10px">
                  <label>Sleep Schedule</label>
                  <select id="s-sleep">
                    <option value="early">Early (10pm - 6am)</option>
                    <option value="normal">Normal (11pm - 7am)</option>
                    <option value="late">Late (1am - 9am)</option>
                  </select>
                </div>

                <div style="margin-top:10px">
                  <label>Cleanliness</label>
                  <select id="s-clean">
                    <option value="0">Messy</option>
                    <option value="1">Average</option>
                    <option value="2">Tidy</option>
                  </select>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px">
                  <div>
                    <label>Smoker?</label>
                    <select id="s-smoke"><option value="no">No</option><option value="yes">Yes</option></select>
                  </div>
                  <div>
                    <label>Preferred Room Type</label>
                    <select id="s-roomp"><option value="single">Single</option><option value="double">Double</option><option value="triple">Triple</option></select>
                  </div>
                </div>

                <div style="margin-top:10px">
                  <label>Interests (comma-separated)</label>
                  <input id="s-interests" placeholder="e.g. music,night-coding,badminton">
                </div>

                <div style="display:flex; gap:8px; margin-top:12px">
                  <button type="submit" class="btn btn-primary">Save</button>
                  <button type="button" id="btn-clear-form" class="btn btn-ghost">Clear</button>
                </div>
              </form>
            </div>

            <div class="card" style="margin-top:12px; max-height:56vh; overflow:auto; padding:8px">
              <div class="user-list" id="student-list" aria-live="polite">
                <!-- student cards injected here -->
              </div>
            </div>
          </div>

          <div style="width:360px">
            <div class="card">
              <h3 style="margin:0">Quick Actions</h3>
              <p class="muted">Tools to speed dataset creation</p>
              <div style="display:grid; gap:8px; margin-top:8px">
                <button class="btn btn-ghost" id="btn-fill-sample">Fill Sample 50</button>
                <button class="btn btn-ghost" id="btn-randomize-rooms">Create Rooms</button>
                <button class="btn btn-ghost" id="btn-balance-genders">Balance Genders</button>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3 style="margin:0">Distribution</h3>
              <canvas id="chart-interest" width="300" height="180" style="width:100%"></canvas>
            </div>
          </div>
        </div>

      </section>

      <!-- MATCHING VIEW -->
      <section id="view-match" class="card" style="display:none">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <div>
            <h2 style="margin:0">Matching</h2>
            <p class="muted">Run the matching algorithm and inspect pairwise compatibility scores.</p>
          </div>
          <div class="controls">
            <button class="btn btn-primary" id="btn-run-match">Run Matching</button>
            <button class="btn btn-ghost" id="btn-visualize">Visualize Graph</button>
          </div>
        </div>

        <div style="display:flex; gap:12px; margin-top:12px">
          <div style="flex:1">
            <div class="card matrix" style="padding:8px; max-height:64vh; overflow:auto">
              <table id="match-table" role="table"></table>
            </div>
          </div>
          <div style="width:360px">
            <div class="card">
              <h3 style="margin:0">Algorithm Notes</h3>
              <p class="muted">Weighted similarity + constraints. Tweak weights in the sidebar for different behaviours.</p>
              <div style="margin-top:8px">
                <label>Top matches to show</label>
                <input id="top-k" type="number" min="1" max="10" value="3">
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3 style="margin:0">Selected Match</h3>
              <div id="selected-match" style="margin-top:10px">—</div>
            </div>
          </div>
        </div>
      </section>

      <!-- ALLOCATION VIEW -->
      <section id="view-allocate" class="card" style="display:none">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <div>
            <h2 style="margin:0">Hostel Allocation</h2>
            <p class="muted">Pack matched roommates into rooms respecting capacity & preferences.</p>
          </div>
          <div class="controls">
            <button class="btn btn-primary" id="btn-run-alloc">Run Allocation</button>
            <button class="btn btn-ghost" id="btn-clear-alloc">Clear Allocation</button>
          </div>
        </div>

        <div style="display:flex; gap:12px; margin-top:12px">
          <div style="flex:1">
            <div class="card rooms" id="rooms-container">
              <!-- room cards injected here -->
            </div>
          </div>
          <div style="width:360px">
            <div class="card">
              <h3 style="margin:0">Allocation Summary</h3>
              <div id="alloc-summary" style="margin-top:8px">No allocation yet.</div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3 style="margin:0">Export</h3>
              <p class="muted">Export allocation as JSON for backend processing or printing.</p>
              <div style="display:flex; gap:8px; margin-top:8px">
                <button class="btn btn-primary" id="btn-export-alloc">Export Allocation</button>
                <button class="btn btn-ghost" id="btn-print-alloc">Print</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- REPORTS VIEW -->
      <section id="view-reports" class="card" style="display:none">
        <div>
          <h2 style="margin:0">Reports & Insights</h2>
          <p class="muted">Graphs, fairness metrics, and downloadable reports.</p>
        </div>

        <div style="display:grid; grid-template-columns:1fr 360px; gap:12px; margin-top:12px">
          <div class="card">
            <h3>Compatibility Distribution</h3>
            <canvas id="chart-compat" width="700" height="250" style="width:100%"></canvas>
          </div>

          <div class="card">
            <h3>Fairness</h3>
            <p class="muted">Gender balance, age distribution, and preference satisfaction scores.</p>
            <div id="fairness-report" style="margin-top:8px">—</div>
            <div style="margin-top:12px">
              <button class="btn btn-ghost" id="btn-download-report">Download JSON Report</button>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <template id="tpl-student-card">
    <div class="user-card" draggable="true">
      <div class="avatar mono">A</div>
      <div class="meta">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <div style="font-weight:800" data-name></div>
          <div class="muted" data-age></div>
        </div>
        <div class="tags" data-tags></div>
      </div>
      <div style="display:flex; flex-direction:column; gap:6px">
        <button class="btn btn-ghost btn-edit" title="Edit">Edit</button>
        <button class="btn btn-ghost btn-del" title="Delete">Delete</button>
      </div>
    </div>
  </template>

  <script>
    /*
      Main JS for RoomMate AI — modular, commented.
      - Data structures
      - Helpers
      - Matching algorithm (similarity + constraints)
      - Allocation algorithm (best-fit + greedy + local improvements)
      - UI wiring and charts
    */

    // ---------- Utilities ----------
    function uid(prefix='id'){
      return prefix + '_' + Math.random().toString(36).slice(2,9);
    }
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
    function sample(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function nowISO(){ return (new Date()).toISOString(); }

    // deep copy
    function deep(obj){ return JSON.parse(JSON.stringify(obj)); }

    // ---------- Data Model (front-end simulated DB) ----------
    const Store = {
      students: [], // {id,name,age,gender,program,sleep,clean,smoke,roomPref,interests}
      rooms: [],    // {id,name,capacity}
      matchScores: {}, // {pairKey: score}
      allocation: {}, // roomId -> [studentIds]

      save(){
        localStorage.setItem('rm_ai_store', JSON.stringify({students:this.students, rooms:this.rooms, allocation:this.allocation}));
      },
      load(){
        const data = JSON.parse(localStorage.getItem('rm_ai_store')||'null');
        if(data){ this.students = data.students||[]; this.rooms = data.rooms||[]; this.allocation = data.allocation||{}; }
      },
      reset(){ this.students=[]; this.rooms=[]; this.matchScores={}; this.allocation={}; localStorage.removeItem('rm_ai_store');}
    };

    // ---------- Matching Algorithm ----------
    /* Approach:
       - compute pairwise similarity using features: age, sleep, clean, smoke, interests
       - normalize & weight according to controls
       - preference compatibility: same room preference, program, gender bonus/penalty
       - store top-K for UI and full matrix for allocation
       - small hill-climb improvement to break ties and encourage diversity
    */

    function preprocessInterests(listStr){
      return listStr.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
    }

    function jaccard(a,b){
      if(!a.length || !b.length) return 0;
      const A = new Set(a), B = new Set(b);
      let inter=0; for(const x of A) if(B.has(x)) inter++;
      const uni = new Set([...A,...B]).size;
      return inter/Math.max(1, uni);
    }

    function computeScore(s1,s2,weights){
      // numeric closeness
      const ageDiff = Math.abs((s1.age||20)-(s2.age||20));
      const ageScore = 1 - clamp(ageDiff/10, 0, 1); // closer ages => higher

      const sleepScore = (s1.sleep === s2.sleep)?1:0.5; // same schedule preferred
      const cleanScore = 1 - Math.abs((s1.clean||1)-(s2.clean||1))/2;
      const smokeScore = (s1.smoke === s2.smoke)?1:0; // mismatch is bad

      const interests1 = s1.interests||[];
      const interests2 = s2.interests||[];
      const interestScore = jaccard(interests1, interests2);

      // preference bonus
      let prefBonus = 0;
      if(s1.roomPref && s2.roomPref && s1.roomPref === s2.roomPref) prefBonus += 0.08;
      if(s1.program && s2.program && s1.program.toLowerCase() === s2.program.toLowerCase()) prefBonus += 0.06;

      // gender handling — allow mixed but reduce if both prefer same gender environment? keep flexible
      let genderScore = (s1.gender === s2.gender)?1:0.6;

      const weighted = (
        weights.age * ageScore +
        weights.sleep * sleepScore +
        weights.clean * cleanScore +
        weights.smoke * smokeScore +
        weights.interest * interestScore +
        weights.gender * genderScore
      );

      // normalize roughly to 0..1
      const maxW = weights.age + weights.sleep + weights.clean + weights.smoke + weights.interest + weights.gender;
      const base = weighted / Math.max(1e-6, maxW);
      const score = clamp(base + prefBonus, 0, 1);
      return score;
    }

    function pairKey(a,b){ return [a,b].sort().join('::'); }

    function runMatching(opts={}){
      // opts: weights (age,sleep,clean,smoke,interest,gender)
      const students = Store.students;
      const n = students.length;
      const weights = Object.assign({age:1, sleep:1, clean:1, smoke:1, interest:1, gender:0.4}, opts.weights||{});
      const result = {};
      for(let i=0;i<n;i++){
        for(let j=i+1;j<n;j++){
          const a=students[i], b=students[j];
          const score = computeScore(a,b,weights);
          result[pairKey(a.id,b.id)] = score;
        }
      }
      Store.matchScores = result;
      return result;
    }

    // ---------- Allocation Algorithm ----------
    /* Steps:
      1) Use matches to create compatible groups (pairs/triples) via greedy grouping
      2) Fit groups into rooms using best fit by capacity
      3) Perform local improvement: swap students across rooms if it improves overall satisfaction
    */

    function buildGroupsFromMatches(k=3){
      // build small groups by greedy picking best matches
      const students = Store.students.slice();
      const used = new Set();
      const groups = [];
      const pairs = Object.entries(Store.matchScores).sort((a,b)=>b[1]-a[1]);

      for(const [key,score] of pairs){
        if(score<0.2) break; // don't group very low compat
        const [a,b] = key.split('::');
        if(used.has(a) || used.has(b)) continue;
        used.add(a); used.add(b);
        let group = [a,b];
        // try to add a third friend with good score to both
        if(k>=3){
          const candidates = students.filter(s=>!used.has(s.id));
          let bestC=null, bestScore=-1;
          for(const c of candidates){
            const sAC = Store.matchScores[pairKey(a,c.id)]||0;
            const sBC = Store.matchScores[pairKey(b,c.id)]||0;
            const avg = (sAC + sBC)/2;
            if(avg>bestScore){ bestScore = avg; bestC = c; }
          }
          if(bestScore>0.35 && bestC){ group.push(bestC.id); used.add(bestC.id); }
        }
        groups.push(group);
      }
      // remaining singles
      for(const s of students){ if(!used.has(s.id)) groups.push([s.id]); }
      return groups;
    }

    function scoreAllocation(allocation){
      // allocation: roomId-> [studentIds]
      // compute average pairwise compat within rooms
      let tot=0, cnt=0;
      for(const r in allocation){
        const arr = allocation[r];
        for(let i=0;i<arr.length;i++){
          for(let j=i+1;j<arr.length;j++){
            const sk = pairKey(arr[i], arr[j]);
            const s = Store.matchScores[sk]||0;
            tot += s; cnt++;
          }
        }
      }
      return cnt? tot/cnt : 0;
    }

    function runAllocation(){
      // create groups
      const groups = buildGroupsFromMatches(3);
      // make mutable rooms list sorted by capacity desc
      const rooms = Store.rooms.map(r=>({...r, occupants:[] })).sort((a,b)=>b.capacity-a.capacity);

      // naive greedy: place largest groups first
      groups.sort((a,b)=>b.length-a.length);
      const allocation = {};
      for(const g of groups){
        // try to find room that fits exactly or close
        rooms.sort((a,b)=> (a.capacity - a.occupants.length) - (b.capacity - b.occupants.length));
        let placed=false;
        for(const room of rooms){
          if(room.occupants.length + g.length <= room.capacity){
            room.occupants.push(...g);
            placed=true; break;
          }
        }
        if(!placed){
          // try to split group across rooms
          let remain = g.slice();
          for(const room of rooms){
            const space = room.capacity - room.occupants.length;
            if(space<=0) continue;
            const take = remain.splice(0, space);
            room.occupants.push(...take);
            if(remain.length===0) break;
          }
        }
      }

      for(const r of rooms){ allocation[r.id] = r.occupants.slice(); }
      Store.allocation = allocation;

      // local improvement: try swapping two students across rooms if improves score
      let improved=true, iter=0;
      while(improved && iter<300){
        improved=false; iter++;
        const roomIds = Object.keys(allocation);
        for(let i=0;i<roomIds.length;i++){
          for(let j=i+1;j<roomIds.length;j++){
            const A = allocation[roomIds[i]]; const B = allocation[roomIds[j]];
            for(let aIdx=0;aIdx<A.length;aIdx++){
              for(let bIdx=0;bIdx<B.length;bIdx++){
                // swap and evaluate
                const newAlloc = deep(allocation);
                const aId=A[aIdx], bId=B[bIdx];
                newAlloc[roomIds[i]][aIdx] = bId;
                newAlloc[roomIds[j]][bIdx] = aId;
                const oldScore = scoreAllocation(allocation);
                const newScore = scoreAllocation(newAlloc);
                if(newScore > oldScore + 0.0001){ allocation = newAlloc; improved=true; }
                if(improved) break;
              }
              if(improved) break;
            }
            if(improved) break;
          }
          if(improved) break;
        }
      }
      Store.allocation = allocation;
      Store.save();
      return allocation;
    }

    // ---------- UI Wiring ----------
    const el = (id)=>document.getElementById(id);
    const tpl = (id)=>document.getElementById(id).content;

    function updateCounts(){ el('count-students').textContent = Store.students.length; el('count-rooms').textContent = Store.rooms.length; const pct = clamp(Store.students.length / Math.max(1,Store.rooms.reduce((s,r)=>s+r.capacity,0)),0,1)*100; el('progress-bar').style.width = pct + '%'; }

    function renderStudentList(){
      const list = el('student-list'); list.innerHTML='';
      const template = tpl('tpl-student-card');
      for(const s of Store.students){
        const node = template.cloneNode(true).firstElementChild;
        node.querySelector('.avatar').textContent = (s.name||'U').split(' ').map(x=>x[0]).slice(0,2).join('').toUpperCase();
        node.querySelector('[data-name]').textContent = s.name;
        node.querySelector('[data-age]').textContent = s.program + ' • ' + s.age;
        const tags = node.querySelector('[data-tags]');
        tags.innerHTML = '';
        const t1 = document.createElement('div'); t1.className='tag'; t1.textContent = s.sleep + ' • clean:' + s.clean; tags.appendChild(t1);
        const t2 = document.createElement('div'); t2.className='tag'; t2.textContent = s.roomPref; tags.appendChild(t2);
        const t3 = document.createElement('div'); t3.className='tag'; t3.textContent = (s.interests||[]).slice(0,3).join(', '); tags.appendChild(t3);

        node.querySelector('.btn-edit').addEventListener('click', ()=>{ populateForm(s.id); });
        node.querySelector('.btn-del').addEventListener('click', ()=>{ if(confirm('Delete '+s.name+'?')){ Store.students = Store.students.filter(x=>x.id!==s.id); Store.save(); renderStudentList(); updateCounts(); } });

        // drag-and-drop support for manual placement
        node.addEventListener('dragstart', (ev)=>{
          ev.dataTransfer.setData('text/plain', s.id);
          node.classList.add('dragging');
        });
        node.addEventListener('dragend', ()=> node.classList.remove('dragging'));

        list.appendChild(node);
      }
    }

    function populateForm(id){
      const s = Store.students.find(x=>x.id===id); if(!s) return;
      el('s-name').value = s.name; el('s-age').value = s.age; el('s-gender').value = s.gender; el('s-program').value = s.program; el('s-sleep').value = s.sleep; el('s-clean').value = s.clean; el('s-smoke').value = s.smoke; el('s-roomp').value = s.roomPref; el('s-interests').value = (s.interests||[]).join(',');
      // change submit handler to update existing
      formMode.editId = id; document.querySelector('#student-form .btn-primary').textContent='Update';
    }

    function clearForm(){ el('s-name').value=''; el('s-age').value=20; el('s-gender').value='m'; el('s-program').value=''; el('s-sleep').value='normal'; el('s-clean').value='1'; el('s-smoke').value='no'; el('s-roomp').value='double'; el('s-interests').value=''; formMode.editId=null; document.querySelector('#student-form .btn-primary').textContent='Save'; }
    const formMode = {editId:null};

    function attachForm(){
      const form = document.getElementById('student-form');
      form.addEventListener('submit', (ev)=>{
        ev.preventDefault();
        const payload = {
          id: formMode.editId || uid('s'),
          name: el('s-name').value.trim() || 'Unnamed',
          age: Number(el('s-age').value)||20,
          gender: el('s-gender').value,
          program: el('s-program').value.trim()||'—',
          sleep: el('s-sleep').value,
          clean: Number(el('s-clean').value),
          smoke: el('s-smoke').value,
          roomPref: el('s-roomp').value,
          interests: preprocessInterests(el('s-interests').value||'')
        };
        if(formMode.editId){
          Store.students = Store.students.map(s=> s.id===formMode.editId ? payload : s);
        } else {
          Store.students.push(payload);
        }
        Store.save(); renderStudentList(); updateCounts(); clearForm();
      });

      el('btn-clear-form').addEventListener('click', ()=> clearForm());
    }

    // ---------- Charts (vanilla canvas) ----------
    function drawInterestChart(){
      const canvas = document.getElementById('chart-interest'); const ctx = canvas.getContext('2d');
      const interests = {};
      for(const s of Store.students){ for(const i of s.interests||[]){ interests[i] = (interests[i]||0) + 1; }}
      const entries = Object.entries(interests).sort((a,b)=>b[1]-a[1]).slice(0,6);
      // clear
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // draw bars
      const w = canvas.width; const h = canvas.height; const pad=24; const barW = (w-2*pad)/(entries.length||1);
      const max = Math.max(1, ...entries.map(e=>e[1]));
      for(let i=0;i<entries.length;i++){
        const [k,v]=entries[i];
        const bw = barW*0.6; const x = pad + i*barW + (barW-bw)/2; const barH = (v/max)*(h-2*pad);
        ctx.fillStyle = 'rgba(255,255,255,0.08)';
        ctx.fillRect(x, h-pad-barH, bw, barH);
        ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.font='12px Inter, sans-serif'; ctx.fillText(k, x, h-pad+12);
      }
    }

    function drawCompatChart(){
      const canvas = document.getElementById('chart-compat'); const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const scores = Object.values(Store.matchScores || {});
      if(scores.length===0){ ctx.fillStyle='var(--muted)'; ctx.fillText('Run matching to see compatibility distribution',20,20); return; }
      // histogram
      const bins = new Array(10).fill(0);
      for(const s of scores){ const idx = Math.min(9, Math.floor(s*10)); bins[idx]++; }
      const w = canvas.width; const h = canvas.height; const pad=32; const bw = (w-2*pad)/bins.length;
      const max = Math.max(...bins);
      for(let i=0;i<bins.length;i++){
        const x = pad + i*bw; const barH = (bins[i]/(max||1))*(h-2*pad);
        ctx.fillStyle='rgba(255,255,255,0.08)'; ctx.fillRect(x, h-pad-barH, bw*0.8, barH);
        ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.fillText((i/10).toFixed(1)+'-'+((i+1)/10).toFixed(1), x, h-pad+14);
      }
    }

    // ---------- Render match table ----------
    function renderMatchTable(){
      const table = el('match-table'); table.innerHTML='';
      const students = Store.students;
      if(students.length<2){ table.innerHTML = '<tr><td class="muted">Add more students to compute pairwise compatibility.</td></tr>'; return; }
      // header
      const thead = document.createElement('thead'); const thr = document.createElement('tr'); thr.innerHTML = '<th></th>' + students.map(s=>'<th>'+escapeHtml(s.name.split(' ')[0])+'</th>').join(''); thead.appendChild(thr); table.appendChild(thead);
      const tbody = document.createElement('tbody');
      for(const a of students){
        const tr = document.createElement('tr'); tr.innerHTML = '<td><strong>'+escapeHtml(a.name.split(' ')[0])+'</strong></td>' + students.map(b=>{
          if(a.id===b.id) return '<td class="muted">—</td>';
          const s = Store.matchScores[pairKey(a.id,b.id)]||0;
          return '<td class="score">'+(s.toFixed(2))+'</td>';
        }).join(''); tbody.appendChild(tr);
      }
      table.appendChild(tbody);
    }

    function escapeHtml(text){ return (text+'').replace(/[&<>"]+/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // ---------- Rooms rendering & drag drop allocation ----------
    function renderRooms(){
      const container = el('rooms-container'); container.innerHTML='';
      for(const r of Store.rooms){
        const div = document.createElement('div'); div.className='room card'; div.id = 'room_'+r.id;
        const title = document.createElement('div'); title.className='room-name'; title.textContent = r.name + ' • ' + r.capacity + ' bed';
        div.appendChild(title);
        const list = document.createElement('div'); list.style.display='flex'; list.style.flexDirection='column'; list.style.gap='8px'; list.style.marginTop='8px'; list.dataset.roomId = r.id;
        const occ = Store.allocation[r.id] || [];
        for(const sid of occ){ const s = Store.students.find(x=>x.id===sid); if(!s) continue; const card = document.createElement('div'); card.className='user-card small'; card.draggable=true; card.innerHTML = '<div class="avatar mono">'+(s.name.split(' ').map(x=>x[0]).slice(0,2).join('').toUpperCase())+'</div><div style="flex:1"><div style="font-weight:800">'+escapeHtml(s.name)+'</div><div class="muted">'+s.program+'</div></div>'; card.addEventListener('dragstart', (ev)=>{ ev.dataTransfer.setData('text/plain', s.id); card.classList.add('dragging'); }); card.addEventListener('dragend', ()=>card.classList.remove('dragging'));
          list.appendChild(card);
        }
        // allow drop
        list.addEventListener('dragover', (e)=>{ e.preventDefault(); list.classList.add('drag-target'); });
        list.addEventListener('dragleave', ()=> list.classList.remove('drag-target'));
        list.addEventListener('drop', (e)=>{
          e.preventDefault(); list.classList.remove('drag-target'); const sid = e.dataTransfer.getData('text/plain'); // remove from previous allocation
          // remove student from other rooms
          for(const rid in Store.allocation){ Store.allocation[rid] = Store.allocation[rid].filter(x=>x!==sid); }
          // add to this room if space
          const room = Store.rooms.find(x=>x.id===r.id);
          if((Store.allocation[r.id]||[]).length < room.capacity){ Store.allocation[r.id] = (Store.allocation[r.id]||[]).concat([sid]); Store.save(); renderRooms(); renderAllocSummary(); }
        });

        div.appendChild(list);
        container.appendChild(div);
      }
    }

    function renderAllocSummary(){
      const s = el('alloc-summary');
      const alloc = Store.allocation; let html=''; let totalAssigned=0;
      for(const r of Store.rooms){ const arr = alloc[r.id]||[]; totalAssigned += arr.length; html += '<div style="margin-bottom:6px"><strong>'+escapeHtml(r.name)+'</strong> — '+arr.length+' / '+r.capacity+'</div>'; }
      html += '<div style="margin-top:10px"><strong>Total assigned:</strong> '+totalAssigned+' / '+Store.students.length+'</div>';
      s.innerHTML = html;
    }

    // ---------- Import / Export / Helpers ----------
    function exportJSON(){ const payload = {students:Store.students, rooms:Store.rooms, allocation:Store.allocation, meta:{generated:nowISO()}}; return JSON.stringify(payload, null, 2); }
    function importJSON(jsonStr){ try{ const data = JSON.parse(jsonStr); if(data.students) Store.students = data.students; if(data.rooms) Store.rooms = data.rooms; if(data.allocation) Store.allocation = data.allocation; Store.save(); return true; }catch(e){ console.error(e); return false; } }

    // ---------- Sample Data Generator ----------
    const sampleNames = ['Riya Sharma','Aman Patel','Sana Khan','Vikram Rao','Meera Iyer','Arjun Singh','Nisha Gupta','Karthik Menon','Tara Bose','Rohit Verma','Siddharth Nair','Pooja Desai','Kunal Chopra','Isha Roy','Neha Malhotra','Rahul Jain','Anita Das','Devika Sengupta','Pranav Bose','Lalit Kumar','Zara Ali','Omar Sheikh','Rakesh Sharma','Priya Nair','Manish Agarwal','Siddhi Shah','Yash Bhatia','Anya Kapoor','Harsh Vyas','Sohail Khan'];
    const sleepOpts = ['early','normal','late'];
    const interestsPool = ['music','sports','coding','reading','gaming','cooking','yoga','photography','debate','dance','travel','movies','startups','entrepreneurship','badminton'];

    function addRandomStudents(n=20){
      for(let i=0;i<n;i++){
        const name = sample(sampleNames) + ' ' + Math.floor(Math.random()*100);
        const s = { id: uid('s'), name, age: 18 + Math.floor(Math.random()*7), gender: sample(['m','f']), program: sample(['B.Tech CSE','B.Sc','BBA','MCA','MBA','B.Des']), sleep: sample(sleepOpts), clean: Math.floor(Math.random()*3), smoke: Math.random()<0.05 ? 'yes':'no', roomPref: sample(['single','double','triple']), interests: [sample(interestsPool), sample(interestsPool)] };
        s.interests = Array.from(new Set(s.interests)); Store.students.push(s);
      }
      Store.save(); renderStudentList(); updateCounts();
    }

    function createRooms(n=12){ Store.rooms=[]; for(let i=0;i<n;i++){ const cap = [1,2,3][Math.floor(Math.random()*3)]; Store.rooms.push({id:uid('r'), name:'Block '+String.fromCharCode(65+Math.floor(i/6))+' - '+(i+1), capacity:cap}); } Store.save(); updateCounts(); }

    // ---------- Wiring controls ----------
    function attachControls(){
      el('btn-add-random').addEventListener('click', ()=>{ addRandomStudents(20); drawInterestChart(); });
      el('btn-fill-sample').addEventListener('click', ()=>{ addRandomStudents(50); createRooms(20); drawInterestChart(); renderRooms(); renderAllocSummary(); });
      el('btn-randomize-rooms').addEventListener('click', ()=>{ createRooms(18); renderRooms(); });
      el('btn-new-student').addEventListener('click', ()=>{ clearForm(); window.scrollTo({top:0, behavior:'smooth'}); });

      el('btn-import').addEventListener('click', ()=>{
        const txt = prompt('Paste exported JSON here'); if(!txt) return; if(importJSON(txt)){ alert('Imported successfully'); renderStudentList(); renderRooms(); updateCounts(); drawInterestChart(); } else alert('Invalid JSON');
      });
      el('btn-export').addEventListener('click', ()=>{ const data = exportJSON(); prompt('Copy JSON (Ctrl+C)', data); });
      el('btn-reset').addEventListener('click', ()=>{ if(confirm('Reset all data?')){ Store.reset(); renderStudentList(); renderRooms(); updateCounts(); drawInterestChart(); renderMatchTable(); renderAllocSummary(); } });

      // nav
      el('nav-students').addEventListener('click', ()=> showView('students'));
      el('nav-match').addEventListener('click', ()=> showView('match'));
      el('nav-allocate').addEventListener('click', ()=> showView('allocate'));
      el('nav-reports').addEventListener('click', ()=> showView('reports'));

      el('btn-run-match').addEventListener('click', ()=>{
        const prefWeight = Number(el('pref-weight').value);
        const compWeight = Number(el('comp-weight').value);
        // map compact controls into component weights
        const weights = { age:1*compWeight, sleep:0.9*compWeight, clean:0.8*compWeight, smoke:1*compWeight, interest:1.2*compWeight, gender:0.6*compWeight };
        // run
        runMatching({weights}); renderMatchTable(); drawCompatChart(); alert('Matching completed');
      });

      el('btn-run-alloc').addEventListener('click', ()=>{
        if(Store.rooms.length===0){ if(!confirm('No rooms found, create 12 sample rooms?')) return; createRooms(12); renderRooms(); updateCounts(); }
        const alloc = runAllocation(); renderRooms(); renderAllocSummary(); alert('Allocation finished — score: '+(scoreAllocation(alloc)||0).toFixed(3));
      });

      el('btn-clear-alloc').addEventListener('click', ()=>{ Store.allocation = {}; Store.save(); renderRooms(); renderAllocSummary(); });
      el('btn-export-alloc').addEventListener('click', ()=>{ const txt = JSON.stringify(Store.allocation, null, 2); prompt('Allocation JSON', txt); });
      el('btn-print-alloc').addEventListener('click', ()=>{ const w = window.open('', '_blank'); w.document.write('<pre>'+escapeHtml(JSON.stringify(Store.allocation, null, 2))+'</pre>'); w.print(); });

      el('btn-visualize').addEventListener('click', ()=>{ visualizeGraph(); });
      el('btn-simulate-preferences').addEventListener('click', ()=>{ simulatePrefs(); });
      el('btn-balance-genders').addEventListener('click', ()=>{ balanceGenders(); renderStudentList(); });
      el('btn-download-report').addEventListener('click', ()=>{ const report = {timestamp:nowISO(), students:Store.students.length, rooms:Store.rooms.length, allocation:Store.allocation, score:scoreAllocation(Store.allocation)}; const txt = JSON.stringify(report,null,2); prompt('Report JSON', txt); });

      el('btn-fill-sample').addEventListener('click', ()=>{ addRandomStudents(50); createRooms(16); renderRooms(); drawInterestChart(); });

      // export/import from file drag & drop (simple)
      window.addEventListener('dragover', (e)=> e.preventDefault());
      window.addEventListener('drop', (e)=>{ e.preventDefault(); const f = e.dataTransfer.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=>{ if(importJSON(reader.result)){ alert('Imported file'); renderStudentList(); renderRooms(); updateCounts(); } else alert('Bad JSON'); }; reader.readAsText(f); });
    }

    // ---------- Small utilities for simulation ----------
    function simulatePrefs(){ for(const s of Store.students){ // randomly set some interests
        if(!s.interests || s.interests.length===0) s.interests = [sample(interestsPool)];
        if(Math.random()>0.8) s.interests.push(sample(interestsPool));
      } Store.save(); drawInterestChart(); alert('Simulated preferences for '+Store.students.length+' students'); }

    function balanceGenders(){
      // attempt to flip gender labels for some students to balance distribution (simulation-only)
      const counts = Store.students.reduce((acc,s)=>{acc[s.gender] = (acc[s.gender]||0)+1; return acc;},{ });
      const genders = ['m','f','o']; let maxG = Object.keys(counts).reduce((a,b)=>counts[a]>counts[b]?a:b);
      // flip random from maxG to others until balanced-ish
      while(true){ const maxCount = Math.max(...Object.values(counts)); const minCount = Math.min(...Object.values(counts)); if(maxCount - minCount <= 2) break; const cand = Store.students.filter(s=>s.gender===maxG); if(!cand.length) break; const pick = sample(cand); pick.gender = sample(genders); counts[maxG]--; counts[pick.gender] = (counts[pick.gender]||0)+1; }
      Store.save(); alert('Gender balancing attempt done'); }

    // ---------- Graph Visualizer (simple force layout) ----------
    function visualizeGraph(){
      // build a simple SVG in a popup to visualize top matches
      const w=800, h=600; const popup = window.open('', '_blank', 'width='+w+',height='+h);
      const nodes = Store.students.map(s=>({id:s.id, name:s.name}));
      // edges: top N matches
      const edges = Object.entries(Store.matchScores||{}).sort((a,b)=>b[1]-a[1]).slice(0, Math.min(200, nodes.length*3)).map(([k,v])=>{ const [a,b]=k.split('::'); return {a,b,w:v}; });
      // naive circle layout
      let svg = '<svg width="'+w+'" height="'+h+'" viewBox="0 0 '+w+' '+h+'" xmlns="http://www.w3.org/2000/svg">';
      const cx=w/2, cy=h/2, R=Math.min(w,h)/2 - 80;
      const pos = {};
      for(let i=0;i<nodes.length;i++){ const ang = (i/nodes.length)*Math.PI*2; pos[nodes[i].id] = {x: cx + Math.cos(ang)*R, y: cy + Math.sin(ang)*R}; }
      for(const e of edges){ const p1=pos[e.a], p2=pos[e.b]; const wth = 1 + Math.round(e.w*4); svg += '<line x1="'+p1.x+'" y1="'+p1.y+'" x2="'+p2.x+'" y2="'+p2.y+'" stroke="rgba(255,255,255,'+(0.05+e.w*0.6)+')" stroke-width="'+wth+'" />'; }
      for(const n of nodes){ const p=pos[n.id]; svg += '<g><circle cx="'+p.x+'" cy="'+p.y+'" r="12" fill="rgba(124,58,237,0.9)"/><text x="'+(p.x+18)+'" y="'+(p.y+6)+'" fill="#fff" font-size="12">'+escapeHtml(n.name.split(' ')[0])+'</text></g>'; }
      svg += '</svg>';
      popup.document.body.style.background='#071126'; popup.document.body.style.margin='0'; popup.document.body.innerHTML = svg;
    }

    // ---------- Init ----------
    (function init(){
      Store.load(); attachForm(); attachControls(); renderStudentList(); updateCounts(); renderRooms(); renderAllocSummary(); drawInterestChart(); drawCompatChart();
      // wire nav buttons active class
      document.querySelectorAll('.menu button').forEach(btn=> btn.addEventListener('click', ()=>{ document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }));
    })();

    function showView(name){ document.getElementById('view-students').style.display = name==='students' ? '' : 'none'; document.getElementById('view-match').style.display = name==='match' ? '' : 'none'; document.getElementById('view-allocate').style.display = name==='allocate' ? '' : 'none'; document.getElementById('view-reports').style.display = name==='reports' ? '' : 'none'; }

    // prevent accidental data loss
    window.addEventListener('beforeunload', (e)=>{ /* nothing heavy */ });

  </script>
</body>
</html>
